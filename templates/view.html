<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnForge - Document Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css" id="hljs-light">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css" id="hljs-dark" disabled>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght@6..144,1..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fa71.pages.dev/css/all.css">
    <script>
        (function() {
            const savedTheme = localStorage.getItem('learnforge_theme') || 'light';
            document.documentElement.classList.remove('light', 'dark');
            document.documentElement.classList.add(savedTheme);
        })();
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'light-bg': '#FFFFFF',
                        'light-sidebar': '#F9F9F9',
                        'light-hover': '#ECECEC',
                        'light-border': '#E5E5E5',
                        'light-text': '#0D0D0D',
                        'light-text-secondary': '#666666',
                        'light-text-muted': '#999999',
                        'dark-bg': '#212121',
                        'dark-sidebar': '#171717',
                        'dark-hover': '#2F2F2F',
                        'dark-border': '#3E3E3E',
                        'dark-text': '#ECECEC',
                        'dark-text-secondary': '#B4B4B4',
                        'dark-text-muted': '#8E8E8E',
                    },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Google Sans Flex', sans-serif; }
        * { transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.1); border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); }

        .answer-text { line-height: 1.8; }
        .answer-text h1 { font-size: 1.75rem; font-weight: 700; margin: 1.5rem 0 1rem; }
        .answer-text h2 { font-size: 1.5rem; font-weight: 600; margin: 1.25rem 0 0.75rem; }
        .answer-text h3 { font-size: 1.25rem; font-weight: 600; margin: 1rem 0 0.5rem; }
        .answer-text h4 { font-size: 1.1rem; font-weight: 600; margin: 0.75rem 0 0.5rem; }
        .answer-text p { margin: 0.75rem 0; }
        .answer-text ul, .answer-text ol { margin: 0.75rem 0; padding-left: 1.5rem; }
        .answer-text li { margin: 0.25rem 0; }
        .answer-text ul { list-style-type: disc; }
        .answer-text ol { list-style-type: decimal; }
        .answer-text code:not(pre code) {
            background: rgba(0,0,0,0.05);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }
        .dark .answer-text code:not(pre code) { background: rgba(255,255,255,0.1); }
        .answer-text pre {
            margin: 1rem 0;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .answer-text pre code {
            display: block;
            padding: 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }
        .answer-text blockquote {
            border-left: 3px solid #ddd;
            margin: 1rem 0;
            padding-left: 1rem;
            color: #666;
        }
        .dark .answer-text blockquote {
            border-left-color: #555;
            color: #aaa;
        }
        .answer-text table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .answer-text th, .answer-text td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }
        .dark .answer-text th, .dark .answer-text td {
            border-color: #444;
        }
        .answer-text th {
            background: rgba(0,0,0,0.05);
        }
        .dark .answer-text th {
            background: rgba(255,255,255,0.05);
        }
        .answer-text a {
            color: #2563eb;
            text-decoration: underline;
        }
        .dark .answer-text a {
            color: #60a5fa;
        }
        .answer-text hr {
            margin: 1.5rem 0;
            border: none;
            border-top: 1px solid #ddd;
        }
        .dark .answer-text hr {
            border-top-color: #444;
        }
        .code-block-wrapper {
            position: relative;
            margin: 1rem 0;
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f5f5f5;
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .dark .code-block-header {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }
        .code-block-wrapper pre {
            margin: 0;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        /* Shimmer animation */
        .shimmer {
            background: linear-gradient(90deg, #E5E5E5 25%, #F0F0F0 50%, #E5E5E5 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .dark .shimmer {
            background: linear-gradient(90deg, #2F2F2F 25%, #3E3E3E 50%, #2F2F2F 75%);
            background-size: 200% 100%;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text min-h-screen">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 h-14 bg-light-bg dark:bg-dark-bg border-b border-light-border dark:border-dark-border z-50 flex items-center px-4">
        <a href="/chat" class="flex items-center gap-2">
            <div class="w-8 h-8 bg-light-text dark:bg-dark-text rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-light-bg dark:text-dark-bg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
            </div>
            <span class="text-lg font-semibold">LearnForge</span>
        </a>
        <div class="ml-4 flex items-center gap-2">
            <span id="docTitle" class="text-sm text-light-text-secondary dark:text-dark-text-secondary"></span>
        </div>
        <div class="ml-auto flex items-center gap-2">
            <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-light-hover dark:hover:bg-dark-hover">
                <svg class="w-5 h-5 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                </svg>
                <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
            </button>
            <button onclick="window.close()" class="px-3 py-1.5 text-sm bg-light-text dark:bg-dark-text text-light-bg dark:text-dark-bg rounded-lg hover:opacity-90">Close</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-14 min-h-screen">
        <div class="max-w-4xl mx-auto p-6">
            <!-- Document Info -->
            <div id="docInfo" class="mb-6 pb-4 border-b border-light-border dark:border-dark-border hidden">
                <div class="flex items-center justify-between">
                    <h1 id="docFilename" class="text-2xl font-semibold mb-2"></h1>
                    <button id="regenerateBtn" onclick="regenerateSummary()" class="hidden items-center gap-2 px-3 py-1.5 text-sm text-light-text-muted dark:text-dark-text-muted border border-light-border dark:border-dark-border rounded-lg hover:bg-light-hover dark:hover:bg-dark-hover hover:text-light-text dark:hover:text-dark-text transition-colors">
                        <i class="fa-light fa-arrows-rotate"></i>
                        <span>Regenerate</span>
                    </button>
                </div>
                <div class="flex items-center gap-4 text-sm text-light-text-muted dark:text-dark-text-muted">
                    <span id="docType"></span>
                    <span id="docPages"></span>
                    <span id="docMethod"></span>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="py-8">
                <!-- Header skeleton -->
                <div class="mb-6 pb-4 border-b border-light-border dark:border-dark-border">
                    <div class="shimmer h-8 w-3/4 mb-3 rounded"></div>
                    <div class="flex items-center gap-4">
                        <div class="shimmer h-4 w-16 rounded"></div>
                        <div class="shimmer h-4 w-20 rounded"></div>
                    </div>
                </div>

                <!-- Content skeleton -->
                <div class="space-y-4">
                    <div class="shimmer h-6 w-1/3 rounded"></div>
                    <div class="space-y-2">
                        <div class="shimmer h-4 w-full rounded"></div>
                        <div class="shimmer h-4 w-full rounded"></div>
                        <div class="shimmer h-4 w-5/6 rounded"></div>
                    </div>
                    <div class="shimmer h-6 w-1/4 rounded mt-6"></div>
                    <div class="space-y-2">
                        <div class="shimmer h-4 w-full rounded"></div>
                        <div class="shimmer h-4 w-4/5 rounded"></div>
                        <div class="shimmer h-4 w-full rounded"></div>
                        <div class="shimmer h-4 w-3/4 rounded"></div>
                    </div>
                    <div class="shimmer h-6 w-2/5 rounded mt-6"></div>
                    <div class="space-y-2">
                        <div class="shimmer h-4 w-full rounded"></div>
                        <div class="shimmer h-4 w-5/6 rounded"></div>
                    </div>
                </div>

            </div>

            <!-- Error -->
            <div id="error" class="hidden text-center py-12">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-red-50 dark:bg-red-900/30 flex items-center justify-center">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold mb-2">Failed to Load Document</h3>
                <p id="errorMessage" class="text-sm text-light-text-muted dark:text-dark-text-muted"></p>
            </div>

            <!-- Content -->
            <div id="content" class="answer-text hidden"></div>
        </div>
    </main>

    <script>
        const authToken = localStorage.getItem('learnforge_token');

        async function init() {
            if (!authToken) {
                window.location.href = '/signin';
                return;
            }

            // Get document ID from URL
            const pathParts = window.location.pathname.split('/');
            const docId = pathParts[pathParts.length - 1];

            if (!docId) {
                showError('No document ID provided');
                return;
            }

            // Check if this is a summary view
            const urlParams = new URLSearchParams(window.location.search);
            const viewType = urlParams.get('type');
            const isSummary = viewType === 'summary';

            try {
                const endpoint = isSummary
                    ? `/api/documents/${docId}/summary`
                    : `/api/documents/${docId}/content`;

                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    const data = await response.json();
                    showError(data.error || 'Failed to load document');
                    return;
                }

                const data = await response.json();
                displayDocument(data, isSummary);

            } catch (error) {
                showError('Failed to load document: ' + error.message);
            }
        }

        function displayDocument(doc, isSummary = false) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('docInfo').classList.remove('hidden');
            document.getElementById('content').classList.remove('hidden');

            // Get content based on view type
            const content = isSummary ? doc.summary : doc.content;
            const titleSuffix = isSummary ? ' - Summary' : '';

            // Update title
            document.title = `${doc.filename}${titleSuffix} - LearnForge`;
            document.getElementById('docTitle').textContent = doc.filename + titleSuffix;
            document.getElementById('docFilename').textContent = doc.filename + titleSuffix;

            // Update doc info based on view type
            if (isSummary) {
                document.getElementById('docType').innerHTML = '<span class="px-1.5 py-0.5 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded text-xs">SUMMARY</span>';
                document.getElementById('docPages').textContent = '';
                document.getElementById('docMethod').innerHTML = '';
                // Show regenerate button for summary
                document.getElementById('regenerateBtn').classList.remove('hidden');
                document.getElementById('regenerateBtn').classList.add('flex');
            } else {
                document.getElementById('docType').textContent = doc.file_type ? doc.file_type.toUpperCase() : '';
                document.getElementById('docPages').textContent = doc.num_pages ? `${doc.num_pages} pages` : '';
                document.getElementById('docMethod').innerHTML = doc.processing_method === 'ocr'
                    ? '<span class="px-1.5 py-0.5 bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 rounded text-xs">OCR</span>'
                    : '';
                document.getElementById('regenerateBtn').classList.add('hidden');
            }

            // Render markdown content
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = renderMarkdown(content);

            // Apply syntax highlighting
            highlightCode();
            enhanceCodeBlocks(contentDiv);
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        async function regenerateSummary() {
            const pathParts = window.location.pathname.split('/');
            const docId = pathParts[pathParts.length - 1];

            // Update button to show loading state
            const btn = document.getElementById('regenerateBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-light fa-spinner-third animate-spin"></i><span>Regenerating...</span>';
            btn.disabled = true;

            // Show loading skeleton
            document.getElementById('docInfo').classList.add('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            try {
                const response = await fetch(`/api/documents/${docId}/summary?regenerate=true`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to regenerate summary');
                }

                const data = await response.json();
                displayDocument(data, true);

            } catch (error) {
                showError('Failed to regenerate: ' + error.message);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        function renderMarkdown(text) {
            if (!text) return '';

            // Protect LaTeX from markdown processing
            const latexStore = [];

            // Protect block math $$...$$ first
            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, content) => {
                latexStore.push({ content: content.trim(), display: true });
                return `%%LATEXBLOCK${latexStore.length - 1}%%`;
            });

            // Protect inline math $...$ (but not $$ or standalone $)
            text = text.replace(/\$([^$\n]+?)\$/g, (match, content) => {
                latexStore.push({ content: content.trim(), display: false });
                return `%%LATEXINLINE${latexStore.length - 1}%%`;
            });

            // Parse markdown
            let html = marked.parse(text);

            // Restore LaTeX by rendering with KaTeX directly
            html = html.replace(/%%LATEX(BLOCK|INLINE)(\d+)%%/g, (match, type, index) => {
                const item = latexStore[parseInt(index)];
                try {
                    let latexContent = item.content.replace(/\\\\/g, '\\');
                    return katex.renderToString(latexContent, {
                        displayMode: item.display,
                        throwOnError: false
                    });
                } catch (e) {
                    return item.display ? `$$${item.content}$$` : `$${item.content}$`;
                }
            });

            return html;
        }

        function highlightCode() {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function enhanceCodeBlocks(container) {
            const preElements = container.querySelectorAll('pre');
            preElements.forEach((pre) => {
                if (pre.parentElement && pre.parentElement.classList.contains('code-block-wrapper')) return;

                const code = pre.querySelector('code');
                let language = 'code';

                if (code) {
                    const classes = code.className.split(' ');
                    for (const cls of classes) {
                        if (cls.startsWith('language-')) {
                            language = cls.replace('language-', '');
                            break;
                        }
                    }
                }

                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';

                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `
                    <span class="text-xs text-light-text-muted dark:text-dark-text-muted">${language}</span>
                    <button onclick="copyCode(this)" class="text-xs text-light-text-muted dark:text-dark-text-muted hover:text-light-text dark:hover:text-dark-text flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Copy
                    </button>
                `;

                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(header);
                wrapper.appendChild(pre);
            });
        }

        function copyCode(button) {
            const wrapper = button.closest('.code-block-wrapper');
            const code = wrapper.querySelector('code');
            if (code) {
                navigator.clipboard.writeText(code.textContent);
                button.innerHTML = `
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Copied!
                `;
                setTimeout(() => {
                    button.innerHTML = `
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Copy
                    `;
                }, 2000);
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            html.classList.remove('light', 'dark');
            html.classList.add(isDark ? 'light' : 'dark');
            localStorage.setItem('learnforge_theme', isDark ? 'light' : 'dark');

            // Toggle highlight.js theme
            document.getElementById('hljs-light').disabled = !isDark;
            document.getElementById('hljs-dark').disabled = isDark;
        }

        // Initialize highlight.js theme based on current mode
        function initHljsTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('hljs-light').disabled = isDark;
            document.getElementById('hljs-dark').disabled = !isDark;
        }

        initHljsTheme();
        init();
    </script>
</body>
</html>
